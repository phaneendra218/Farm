{% extends "base.html" %}

{% block content %}
<h1>Checkout</h1>

<!-- If no addresses are available -->
{% if addresses|length == 0 %}
  <p>No delivery addresses found. Please add an address.</p>
  <button id="add-address-button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
    Add Address
  </button>
{% else %}
  <form method="POST" action="{{ url_for('checkout') }}">
    <h3>Select Delivery Address</h3>
    <div id="addresses-container">
      {% for address in addresses %}
        <div>
          <input type="radio" name="address_id" value="{{ address.id }}" 
                 {% if default_address and address.id == default_address.id %} checked {% endif %}>
          <label>{{ address.address_type }}: {{ address.address }}</label>
        </div>
      {% endfor %}
    </div>
    <button type="submit" class="btn btn-success">Proceed to Payment</button>
  </form>
{% endif %}

<!-- Modal for Adding Address -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <iframe id="addAddressIframe" src="" frameborder="0" width="100%" height="400px"></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const addAddressButton = document.getElementById('add-address-button');
    const addAddressIframe = document.getElementById('addAddressIframe');
    const addAddressModal = document.getElementById('addAddressModal');
  
    // Load the profile page only when "Add Address" is clicked
    addAddressButton.addEventListener('click', function () {
      console.log("Loading profile page in iframe");
      addAddressIframe.src = "{{ url_for('profile') }}";
    });
  
    // Clear the iframe and refresh addresses after the modal is closed
    addAddressModal.addEventListener('hidden.bs.modal', function () {
      console.log("Modal closed. Clearing iframe and refreshing addresses.");
      addAddressIframe.src = ""; // Clear iframe content
  
      // Fetch updated addresses dynamically
      fetch('{{ url_for("checkout") }}', {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          console.log("Received updated addresses:", data);
          const addressesContainer = document.getElementById('addresses-container');
          if (data.addresses_html) {
            addressesContainer.innerHTML = data.addresses_html;
          } else {
            console.error("No addresses HTML returned from server.");
          }
        })
        .catch(error => {
          console.error("Error fetching updated addresses:", error);
        });
    });
  });
  </script>
  
  
