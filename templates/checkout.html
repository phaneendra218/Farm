{% extends "base.html" %}

{% block content %}
<h1>Checkout</h1>

<!-- If no addresses are available -->
{% if addresses|length == 0 %}
  <p>No delivery addresses found. Please add an address.</p>
  <button id="add-address-button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
    Add Address
  </button>
{% else %}
  <form method="POST" action="{{ url_for('checkout') }}">
    <h3>Select Delivery Address</h3>
    {% for address in addresses %}
      <div>
        <input type="radio" name="address_id" value="{{ address.id }}" 
               {% if default_address and address.id == default_address.id %} checked {% endif %}>
        <label>{{ address.address_type }}: {{ address.address }}</label>
      </div>
    {% endfor %}
    <button type="submit" class="btn btn-success">Proceed to Payment</button>
  </form>
{% endif %}

<!-- Modal for Adding Address -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <iframe src="{{ url_for('profile') }}"></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const addAddressModal = document.getElementById('addAddressModal');

  // Refresh page after modal closes to reload new addresses
  addAddressModal.addEventListener('hidden.bs.modal', function () {
    location.reload();
  });
});
</script>
